/* Generating graphs */
SA.graphLibs['flotr2.min.js'] = function() {
    $('#content_inner').attr('class', 'sa_flotr2');
    $('.social_wrapper').each(function(i) { // FIXME: This is crap. Revise.
        if(i%2 === 0) {
            $(this).addClass('sa_right');
        }
        else {
            $(this).addClass('sa_left');
        }
    });

    var objs = [],
        tmp  = {};

    // Format graph tooltip
    function format(obj) {
        return obj.series.label + ': ' + parseInt(obj.y);
    }

    /* Trends chart */
    var trends = [];
    var trendsHeaders = [];

    // Fetch headings and init sub-arrays
    $('#trends_table thead th').each(function(j) {
        trendsHeaders.push($(this).text());
        trends[j] = [];
    });

    // Parse table
    $('#trends_table tbody tr').each(function(i) {
        $(this).find('td').each(function(j) {
            trends[j].push([i, parseInt($(this).text())]);
        });
    });

    // Add label to the data (used for the legend)
    for(var i=0; i<trends.length; i++) {
        tmp.label = trendsHeaders[i];
        tmp.data = trends[i];
        trends[i] = tmp;
        tmp = new Object;
    }

    // Draw graph
    $('.trends_graph').css({'width': '758px', 'height': '300px'});
    Flotr.draw($('.trends_graph')[0], trends, 
        {
            xaxis: {
                showLabels: false
            },
            mouse: {
                track: true
            }
    
        }
    );

    /* Pie charts */
    $('.social_pie').each(function() {
        $(this).find('tbody tr').each(function() {
            tmp.label = $(this).children('th').text();
            tmp.data  = [[0, parseInt($(this).children('td').text())]];
            objs.push(tmp);
            tmp = new Object;        
        });

        var graphContainer = $('.' + $(this).attr('id').replace(/_table$/, '_graph'))
            .css({'height': '300px', 'width': '350px'}); // TODO: Should be in CSS file targetting only flotr2 containers

        Flotr.draw(graphContainer[0], objs, 
            {
                grid: {
                    verticalLines: false,
                    horizontalLines: false
                },
                xaxis: {
                    showLabels: false
                },
                yaxis: {
                    showLabels: false
                },
                pie: {
                    show: true,
                    explode: 6
                },
                mouse: {
                    track: true,
                    trackFormatter: format,
                    relative: true
                },
                legend: {
                    show: false
                }       
            }
        );

        objs = [];        
    });
}
